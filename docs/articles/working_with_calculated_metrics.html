<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Analysis Workflows And Calculated Metrics • adobeanalyticsr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Analysis Workflows And Calculated Metrics">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-06XDF7JD6E"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-06XDF7JD6E');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">adobeanalyticsr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/working_with_calculated_metrics.html">Analysis Workflows And Calculated Metrics</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/benrwoodard/adobeanalyticsr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Analysis Workflows And Calculated Metrics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/benrwoodard/adobeanalyticsr/blob/HEAD/vignettes/working_with_calculated_metrics.Rmd" class="external-link"><code>vignettes/working_with_calculated_metrics.Rmd</code></a></small>
      <div class="d-none name"><code>working_with_calculated_metrics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="a-little-housekeeping">A little housekeeping<a class="anchor" aria-label="anchor" href="#a-little-housekeeping"></a>
</h2>
<p>This vignette uses the Adobe Analytics University Student Access
account to show how to work with calculated metrics using R and the API.
If you do not have access to the account, you can easily get it by going
to the free LinkedIn Learning course, “Adobe Analytics Essential
Training”, and registering for access.</p>
<p>If you haven’t yet taken the course, it is well worth your time. Eric
Matisoff does a great job walking through all the different amazing
parts of Adobe Analytics, especially Analysis Workspace. Specifically,
check out the third section of the first chapter to see a quick overview
of the calculated metrics builder user interface in action.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>I won’t be going into the any detail around authenticate in this
article so if you are needing more help with that, make sure to check
out the “Getting Started” vignette. With all that being set, let’s get
things going! First, we need to load the libraries and authenticate.</p>
<pre><code><span><span class="co">## Load the packages needed</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://adobeanalyticsr.com">adobeanalyticsr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span> <span class="co">## needed for some of the data wrangling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite" class="external-link">jsonlite</a></span><span class="op">)</span> <span class="co">## Will help in visualizing calculated metrics definitions</span></span>
<span></span>
<span><span class="fu"><a href="../reference/aw_auth.html">aw_auth</a></span><span class="op">(</span><span class="st">'oauth'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##Check to make sure you have been logged into the correct account profile</span></span>
<span><span class="fu"><a href="../reference/get_me.html">get_me</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">company_id</span> <span class="op">&lt;-</span> <span class="st">'adobea8cf'</span></span>
<span><span class="va">rsid</span> <span class="op">&lt;-</span> <span class="st">'igeo1xxpnwcidadobepm'</span></span>
<span></span>
<span><span class="co">## Create a segment to be used farther down in the demo</span></span>
<span><span class="co">#create the segment rule</span></span>
<span><span class="va">segment_rule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/seg_rule.html">seg_rule</a></span><span class="op">(</span>dimension <span class="op">=</span> <span class="st">'mobiledevicename'</span>,</span>
<span>                         verb <span class="op">=</span> <span class="st">'exists'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#build the segment and capture the segment id</span></span>
<span><span class="va">seginfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/seg_build.html">seg_build</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'NON Desktop traffic'</span>, </span>
<span>                     description <span class="op">=</span> <span class="st">'This is a segment that filters out everything that is not associated with an identified mobile device'</span>, </span>
<span>                     rules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">segment_rule</span><span class="op">)</span>, </span>
<span>                     create_seg <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">segid</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">seginfo</span><span class="op">)</span><span class="op">$</span><span class="va">id</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th>globalCompanyId</th>
<th>companyName</th>
</tr></thead>
<tbody><tr class="odd">
<td>adobea8cf</td>
<td>Adobe Analytics University Student Access</td>
</tr></tbody>
</table>
</div>
<div class="section level2">
<h2 id="retrieve-multiple-calculated-metrics">Retrieve multiple calculated metrics<a class="anchor" aria-label="anchor" href="#retrieve-multiple-calculated-metrics"></a>
</h2>
<p>The following example shows a calculated metrics request for a
response localized in US English, limited to the first page, and with
the size of ten responses per page.</p>
<pre><code><span><span class="va">cms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aw_get_calculatedmetrics.html">aw_get_calculatedmetrics</a></span><span class="op">(</span>includeType <span class="op">=</span> <span class="st">'all'</span>, </span>
<span>                                rsids <span class="op">=</span> <span class="va">rsid</span>, </span>
<span>                                company_id <span class="op">=</span> <span class="va">company_id</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cms</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">'pipe'</span><span class="op">)</span></span></code></pre>
<table class="table">
<colgroup>
<col width="13%">
<col width="23%">
<col width="20%">
<col width="18%">
<col width="6%">
<col width="5%">
<col width="6%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">rsid</th>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">description</th>
<th align="left">owner</th>
<th align="left">polarity</th>
<th align="right">precision</th>
<th align="left">type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_612a3e49262f3f1415082cee</td>
<td align="left">Page</td>
<td align="left"></td>
<td align="left">200456743</td>
<td align="left">positive</td>
<td align="right">0</td>
<td align="left">decimal</td>
</tr>
<tr class="even">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_61336bad44b1bd4f51a9e2ae</td>
<td align="left">Bounce Rate (Bounces / Visits)</td>
<td align="left"></td>
<td align="left">200456743</td>
<td align="left">positive</td>
<td align="right">1</td>
<td align="left">percent</td>
</tr>
<tr class="odd">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_61336f20c7e6035b10558588</td>
<td align="left">Pages Count</td>
<td align="left"></td>
<td align="left">200456743</td>
<td align="left">positive</td>
<td align="right">0</td>
<td align="left">decimal</td>
</tr>
<tr class="even">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_61416ee549ff383abc37c6ab</td>
<td align="left">cart convert 1</td>
<td align="left">cart checkouts per page view</td>
<td align="left">200483715</td>
<td align="left">positive</td>
<td align="right">4</td>
<td align="left">decimal</td>
</tr>
<tr class="odd">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_614179ec49ff383abc37c6c3</td>
<td align="left">Conversions</td>
<td align="left"></td>
<td align="left">200484198</td>
<td align="left">positive</td>
<td align="right">0</td>
<td align="left">decimal</td>
</tr>
<tr class="even">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_614a8d494ba44e49bb383be5</td>
<td align="left">cart convert 1</td>
<td align="left"></td>
<td align="left">200484193</td>
<td align="left">positive</td>
<td align="right">4</td>
<td align="left">decimal</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="retrieving-a-single-calculated-metric">Retrieving a single calculated metric<a class="anchor" aria-label="anchor" href="#retrieving-a-single-calculated-metric"></a>
</h2>
<p>To retrieve a single calculated metric, include its id in the
request.</p>
<pre><code><span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aw_get_calculatedmetrics.html">aw_get_calculatedmetrics</a></span><span class="op">(</span>filterByIds <span class="op">=</span> <span class="va">cms</span><span class="op">$</span><span class="va">id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="co">#add the calculated metric</span></span>
<span>                               company_id <span class="op">=</span> <span class="va">company_id</span>,</span>
<span>                               rsids <span class="op">=</span> <span class="va">rsid</span>, </span>
<span>                               expansion <span class="op">=</span> <span class="st">'definition'</span> <span class="co">#use the expansion argument to see the definition</span></span>
<span>                               <span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">cm</span><span class="op">)</span></span></code></pre>
<table style="width:100%;" class="table">
<colgroup>
<col width="15%">
<col width="28%">
<col width="3%">
<col width="9%">
<col width="7%">
<col width="6%">
<col width="7%">
<col width="6%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="left">rsid</th>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">description</th>
<th align="left">owner</th>
<th align="left">polarity</th>
<th align="right">precision</th>
<th align="left">type</th>
<th align="left">definition</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">igeo1xxpnwcidadobepm</td>
<td align="left">cm300010142_612a3e49262f3f1415082cee</td>
<td align="left">Page</td>
<td align="left"></td>
<td align="left">200456743</td>
<td align="left">positive</td>
<td align="right">0</td>
<td align="left">decimal</td>
<td align="left">visualization-group</td>
</tr></tbody>
</table>
</div>
<div class="section level2">
<h2 id="calculated-metric-management-functions">Calculated metric management functions<a class="anchor" aria-label="anchor" href="#calculated-metric-management-functions"></a>
</h2>
<p>Calculated Metrics are comprised of several different mathematical
functions that work on available metrics for a given report suite.</p>
<div class="section level3">
<h3 id="get-all-functions">Get all functions<a class="anchor" aria-label="anchor" href="#get-all-functions"></a>
</h3>
<p>Returns a full list of calculated metric functions that the user can
access. See the <a href="https://experienceleague.adobe.com/en/docs/analytics/components/calculated-metrics/calcmetric-workflow/cm-build-metrics#areas-of-the-calculated-metrics-builder" class="external-link">functions
documentation</a> for more information on available functions.</p>
<pre><code><span><span class="va">all_functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cm_functions.html">get_cm_functions</a></span><span class="op">(</span>company_id <span class="op">=</span> <span class="va">company_id</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">all_functions</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<table class="table">
<colgroup>
<col width="12%">
<col width="4%">
<col width="6%">
<col width="17%">
<col width="52%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">id</th>
<th align="left">category</th>
<th align="left">persistable</th>
<th align="left">name</th>
<th align="left">description</th>
<th align="left">definition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">col-sum</td>
<td align="left">basic</td>
<td align="left">TRUE</td>
<td align="left">Column Sum</td>
<td align="left">Adds all of the numeric values for a metric within a
column (across the elements of a dimension).</td>
<td align="left">calc-metric</td>
</tr>
<tr class="even">
<td align="left">_new-lift-functional</td>
<td align="left">internal</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">calc-metric</td>
</tr>
<tr class="odd">
<td align="left">_lift-cumul-avg-impl</td>
<td align="left">internal</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">calc-metric</td>
</tr>
<tr class="even">
<td align="left">_waskr-N-control</td>
<td align="left">internal</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">calc-metric</td>
</tr>
<tr class="odd">
<td align="left">ls-intercept-quadratic</td>
<td align="left">advanced</td>
<td align="left">TRUE</td>
<td align="left">Quadratic regression: Intercept</td>
<td align="left">Quadratic regression: Y = ( a + b X ) ^ 2, Returns
a.</td>
<td align="left">calc-metric</td>
</tr>
<tr class="even">
<td align="left">_chi2-test-stat</td>
<td align="left">internal</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">calc-metric</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="create-a-calculated-metric">Create a calculated metric<a class="anchor" aria-label="anchor" href="#create-a-calculated-metric"></a>
</h3>
<p>The process of creating a calculated metric has been designed in a
modular way to enable the systematic approach to building and
maintaining complex calculated metrics in the most efficient way. The
goal is to enhance analysis and data science workflows. The essential
elements of a calculated metric are: function, formula, build. The
following code chunks will illustrate the basics of interacting with
each element.</p>
<div class="section level4">
<h4 id="create-a-function-object">Create a function object<a class="anchor" aria-label="anchor" href="#create-a-function-object"></a>
</h4>
<p>Calculated Metrics are comprised of several different mathematical
functions that work on available metrics for a given report suite. See
the <a href="https://experienceleague.adobe.com/en/docs/analytics/components/calculated-metrics/calcmetric-workflow/cm-build-metrics#areas-of-the-calculated-metrics-builder" class="external-link">functions
documentation</a> for more information on available functions.</p>
<p>Currently the package only supports 2 types of functions:</p>
<ol style="list-style-type: decimal">
<li>Any function that take a single metric</li>
</ol>
<ul>
<li>Examples of these functions include
<code>Absolute Value (Row)</code> and <code>Column Maximum</code>. Both
of which apply a function on a single metric. For a full list make sure
to see the <a href="https://experienceleague.adobe.com/en/docs/analytics/components/calculated-metrics/calcmetric-workflow/cm-build-metrics#areas-of-the-calculated-metrics-builder" class="external-link">functions
documentation</a>.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>The <code>Approximate Count Distinct (dimension)</code>
function</li>
</ol>
<ul>
<li>Returns the approximated distinct count of dimension items for the
selected dimension. The function uses the HyperLogLog (HLL) method of
approximating distinct counts. It is configured to guarantee the value
is within 5% of the actual value 95% of the time.</li>
</ul>
<pre><code><span><span class="op">?</span><span class="va">cm_function</span></span>
<span></span>
<span><span class="va">cm_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_function.html">cm_function</a></span><span class="op">(</span></span>
<span>  func <span class="op">=</span> <span class="st">"col-sum"</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"visits"</span>,</span>
<span>  seg_filter <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">cm_func</span>, pretty <span class="op">=</span> <span class="cn">T</span>, auto_unbox <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre>
<p>{ “func”: “col-sum”, “description”: “Column Sum”, “col”: { “func”:
“metric”, “name”: “metrics/visits”, “description”: “Visits” } }</p>
</div>
<div class="section level4">
<h4 id="create-a-formula-object">Create a formula object<a class="anchor" aria-label="anchor" href="#create-a-formula-object"></a>
</h4>
<p>A calculated metric formula takes to metric objects and applies an
operator on them. You can nest formula or function objects within
formulas to create complex operational containers. Keep in mind, unlike
segment containers, these containers function like a math expression and
determine the order of operations.</p>
<pre><code><span><span class="op">?</span><span class="va">cm_formula</span></span>
<span></span>
<span><span class="va">cm_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_formula.html">cm_formula</a></span><span class="op">(</span></span>
<span>  operator <span class="op">=</span> <span class="st">'divide'</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cm_func</span>, <span class="st">"singlepagevisits"</span><span class="op">)</span>,</span>
<span>  seg_filters <span class="op">=</span> <span class="cn">NA</span>, <span class="co">#add segment filters for each metric if needed</span></span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">cm_form</span>, pretty <span class="op">=</span> <span class="cn">T</span>, auto_unbox <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre>
<p>{ “func”: “divide”, “col1”: { “func”: “col-sum”, “description”:
“Column Sum”, “col”: { “func”: “metric”, “name”: “metrics/visits”,
“description”: “Visits” } }, “col2”: { “func”: “metric”, “name”:
“metrics/singlepagevisits”, “description”: “Single Page Visits” } }</p>
</div>
<div class="section level4">
<h4 id="create-a-calculated-metric-object">Create a calculated metric object<a class="anchor" aria-label="anchor" href="#create-a-calculated-metric-object"></a>
</h4>
<p>Using the <code>cm_build</code> function gives the ability to create
and validate simple and complex calculated metrics. If you are familiar
with the calculated metrics user interface you should be able to quickly
recognize what each aspect of the function arguments refer to but fo
those who are less familiar the <a href="https://experienceleague.adobe.com/en/docs/analytics/components/calculated-metrics/calcmetric-workflow/cm-build-metrics" class="external-link">calculated
metrics builder documentation</a> may be of great use.</p>
<pre><code><span><span class="op">?</span><span class="va">cm_build</span></span>
<span></span>
<span><span class="va">cm_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_build.html">cm_build</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">'Test Calculated Metric'</span>,</span>
<span>  description <span class="op">=</span> <span class="st">'Test cm description'</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">cm_form</span>,</span>
<span>  seg_filter <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  polarity <span class="op">=</span> <span class="st">"positive"</span>,</span>
<span>  precision <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"decimal"</span>,</span>
<span>  create_cm <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#should this be created in the UI</span></span>
<span>  debug <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_obj</span></span></code></pre>
<p>{“rsid”:“igeo1xxpnwcidadobepm”,“name”:“Test Calculated
Metric”,“description”:“Test cm
description”,“definition”:{“formula”:{“func”:“divide”,“col1”:{“func”:“col-sum”,“description”:“Column
Sum”,“col”:{“func”:“metric”,“name”:“metrics/visits”,“description”:“Visits”}},“col2”:{“func”:“metric”,“name”:“metrics/singlepagevisits”,“description”:“Single
Page
Visits”}},“version”:[1,0,0],“func”:“calc-metric”},“polarity”:“positive”,“precision”:0,“type”:“decimal”}</p>
</div>
</div>
<div class="section level3">
<h3 id="validate-a-calculated-metric-object">Validate a calculated metric object<a class="anchor" aria-label="anchor" href="#validate-a-calculated-metric-object"></a>
</h3>
<p>Because report suites can have different configurations, dimensions,
or metrics, a calculated metric that is valid in one report suite may
not be valid in another. To determine which calculated metric to use in
different report suites, and why it may or may not be available, you can
use the cm_validate. This endpoint allows you to POST a definition along
with a target report suite id. The validate endpoint responds with
compatibility information on the calculated metric.</p>
<pre><code><span><span class="op">?</span><span class="va">cm_val</span></span>
<span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_val.html">cm_val</a></span><span class="op">(</span><span class="va">cm_obj</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm</span></span></code></pre>
<p>[1] “The calculated metric definition IS VALID”</p>
<p>Once yo determine make we can create the new calculated metric in the
UI by setting the argument <code>create_cm = TRUE</code>.</p>
<pre><code><span><span class="co">#create the calculated metric in the UI</span></span>
<span><span class="va">cm_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_build.html">cm_build</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">'Test Calculated Metric'</span>,</span>
<span>  description <span class="op">=</span> <span class="st">'Test cm description'</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">cm_form</span>,</span>
<span>  seg_filter <span class="op">=</span> <span class="cn">NULL</span>, <span class="co">#include an overall segment filter</span></span>
<span>  polarity <span class="op">=</span> <span class="st">"positive"</span>,</span>
<span>  precision <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"decimal"</span>,</span>
<span>  create_cm <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#should this be created in the UI</span></span>
<span>  debug <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">cm_obj</span><span class="op">)</span></span></code></pre>
<p>{“rsid”:“igeo1xxpnwcidadobepm”,“id”:“cm300010142_6537f60dde0e706af6156fb1”,“name”:“Test
Calculated Metric”,“description”:“Test cm
description”,“isDeleted”:false,“migratedIds”:[],“internal”:false,“owner”:{“id”:200654087},“hidden”:false,“componentType”:“calculatedMetric”,“polarity”:“positive”,“precision”:0,“type”:“decimal”,“definition”:{“formula”:{“func”:“divide”,“col1”:{“func”:“col-sum”,“description”:“Column
Sum”,“col”:{“func”:“metric”,“name”:“metrics/visits”,“description”:“Visits”}},“col2”:{“func”:“metric”,“name”:“metrics/singlepagevisits”,“description”:“Single
Page
Visits”}},“func”:“calc-metric”,“version”:[1,0,0]},“compatibility”:{“identityMetrics”:[{“identity”:“metrics/visits”},{“identity”:“metrics/singlepagevisits”}],“functions”:[“col-sum”,“divide”],“validator_version”:“1.0.0”,“supported_products”:[“oberon”],“supported_schema”:[“schema_oberon”,“schema_frag”]},“legacyId”:““,”categories”:[“Calculated
Metrics”],“modified”:“2023-10-24T16:51:25Z”}</p>
</div>
<div class="section level3">
<h3 id="adding-a-segment-filter">Adding a segment filter<a class="anchor" aria-label="anchor" href="#adding-a-segment-filter"></a>
</h3>
<p>On every level of a calculated metric, function, formula, and object,
you can add an additional level of control by inserting a segment
filter.</p>
<pre><code><span></span>
<span><span class="co"># use the new segment id to create a segment</span></span>
<span><span class="va">cm_obj_seg_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_build.html">cm_build</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">'Test Segment Filtered Calculated Metric'</span>,</span>
<span>  description <span class="op">=</span> <span class="st">'Test cm description that includes a segment id'</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">cm_form</span>,</span>
<span>  seg_filter <span class="op">=</span> <span class="va">segid</span>, <span class="co">#adding the segment here</span></span>
<span>  create_cm <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cm_val.html">cm_val</a></span><span class="op">(</span><span class="va">cm_obj_seg_filter</span><span class="op">)</span></span></code></pre>
<p>[1] “The calculated metric definition IS VALID”</p>
<p>Now that we know it is a valid segment, let’s create it and pull the
data along with the previous segment to see the difference in the
data.</p>
<pre><code><span><span class="co"># use the new segment id to create a segment</span></span>
<span><span class="va">cm_obj_seg_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_build.html">cm_build</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">'Test Segment Filtered Calculated Metric'</span>,</span>
<span>  description <span class="op">=</span> <span class="st">'Test cm description that includes a segment id'</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">cm_form</span>,</span>
<span>  seg_filter <span class="op">=</span> <span class="va">segid</span>, <span class="co">#adding the segment here</span></span>
<span>  create_cm <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_seg_filter</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">cm_obj_seg_filter</span><span class="op">)</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="va">cm_no_seg_filter</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">cm_obj</span><span class="op">)</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="va">df_cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aw_freeform_table.html">aw_freeform_table</a></span><span class="op">(</span>company_id <span class="op">=</span> <span class="va">company_id</span>, </span>
<span>                           rsid <span class="op">=</span> <span class="va">rsid</span>, </span>
<span>                           metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cm_no_seg_filter</span>, <span class="va">cm_seg_filter</span><span class="op">)</span>,</span>
<span>                           dimensions <span class="op">=</span> <span class="st">'daterangeday'</span>, </span>
<span>                           prettynames <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">df_cm</span><span class="op">)</span></span></code></pre>
<table class="table">
<colgroup>
<col width="14%">
<col width="31%">
<col width="54%">
</colgroup>
<thead><tr class="header">
<th align="left">Day</th>
<th align="right">Test Calculated Metric</th>
<th align="right">Test Segment Filtered Calculated Metric</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">2023-09-26</td>
<td align="right">3707.0726</td>
<td align="right">Inf</td>
</tr>
<tr class="even">
<td align="left">2023-09-25</td>
<td align="right">460.1371</td>
<td align="right">465.8842</td>
</tr>
<tr class="odd">
<td align="left">2023-09-27</td>
<td align="right">401.8156</td>
<td align="right">406.0459</td>
</tr>
<tr class="even">
<td align="left">2023-10-20</td>
<td align="right">383.0642</td>
<td align="right">348.4961</td>
</tr>
<tr class="odd">
<td align="left">2023-10-14</td>
<td align="right">373.7211</td>
<td align="right">348.4961</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="update-a-calculated-metric">Update a calculated metric<a class="anchor" aria-label="anchor" href="#update-a-calculated-metric"></a>
</h3>
<p>To update the name or description it is as simple as adding them
within a list function of the <code>updates</code> argument.</p>
<pre><code><span><span class="op">?</span><span class="va">cm_update</span></span>
<span></span>
<span><span class="va">cm_updated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_update.html">cm_update</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="va">cm_no_seg_filter</span>,</span>
<span>  updates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"new name"</span>,</span>
<span>                 description <span class="op">=</span> <span class="st">"this is a new description"</span><span class="op">)</span>,</span>
<span>  locale <span class="op">=</span> <span class="st">"en_US"</span>,</span>
<span>  debug <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Name Change</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`old name` <span class="op">=</span>  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">cm_obj</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>,`new name` <span class="op">=</span> <span class="va">cm_updated</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Description Change</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`old description` <span class="op">=</span>  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">cm_obj</span><span class="op">)</span><span class="op">$</span><span class="va">description</span>,`new description` <span class="op">=</span> <span class="va">cm_updated</span><span class="op">$</span><span class="va">description</span><span class="op">)</span></span></code></pre>
<pre><code>    old name                           new name </code></pre>
<p>“Test Calculated Metric” “new name”</p>
<pre><code>  old description                       new description </code></pre>
<p>“Test cm description” “this is a new description”</p>
<p>For updating an existing calculated metrics within the definition
there is a more complex solution that needs to be done.</p>
<pre><code><span></span>
<span><span class="va">cm_updated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aw_get_calculatedmetrics.html">aw_get_calculatedmetrics</a></span><span class="op">(</span>filterByIds <span class="op">=</span> <span class="va">cm_updated</span><span class="op">$</span><span class="va">id</span>, </span>
<span>                                       expansion <span class="op">=</span> <span class="st">'definition'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#change the col1 values to reflect a new function `mean`</span></span>
<span><span class="va">cm_updated</span><span class="op">$</span><span class="va">definition</span><span class="op">$</span><span class="va">formula</span><span class="op">$</span><span class="va">col1</span><span class="op">$</span><span class="va">func</span> <span class="op">&lt;-</span> <span class="st">'mean'</span></span>
<span><span class="va">cm_updated</span><span class="op">$</span><span class="va">definition</span><span class="op">$</span><span class="va">formula</span><span class="op">$</span><span class="va">col1</span><span class="op">$</span><span class="va">description</span> <span class="op">&lt;-</span> <span class="st">'Mean'</span></span>
<span><span class="va">cm_updated</span><span class="op">$</span><span class="va">definition</span><span class="op">$</span><span class="va">formula</span><span class="op">$</span><span class="va">col1</span><span class="op">$</span><span class="va">`include-zeros`</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="va">cm_update_complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_update.html">cm_update</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="va">cm_updated</span><span class="op">$</span><span class="va">id</span>,</span>
<span>  updates <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/unbox.html" class="external-link">unbox</a></span><span class="op">(</span><span class="va">cm_updated</span><span class="op">)</span>,</span>
<span>  locale <span class="op">=</span> <span class="st">"en_US"</span>,</span>
<span>  debug <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span></code></pre>
<p><code>cm_update_complete$definition$formula$col1$func</code> [1]
“mean”</p>
<p><code>cm_update_complete$definition$formula$col1$description</code>
[1] “Mean”</p>
</div>
<div class="section level3">
<h3 id="copy-a-calculated-metric">Copy a Calculated Metric<a class="anchor" aria-label="anchor" href="#copy-a-calculated-metric"></a>
</h3>
<pre><code><span><span class="va">cm_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aw_get_calculatedmetrics.html">aw_get_calculatedmetrics</a></span><span class="op">(</span>filterByIds <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">cm_obj</span><span class="op">)</span><span class="op">$</span><span class="va">id</span>, </span>
<span>                                   expansion <span class="op">=</span> <span class="st">'definition'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">cm_var</span><span class="op">)</span></span>
<span></span>
<span><span class="va">copy_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_copy.html">cm_copy</a></span><span class="op">(</span>cm_id <span class="op">=</span> <span class="va">cm_var</span><span class="op">$</span><span class="va">id</span>, </span>
<span>                    name <span class="op">=</span> <span class="st">'Here I copy the cm'</span>, </span>
<span>                    description <span class="op">=</span> <span class="st">'I want to add a new description'</span>, </span>
<span>                    polarity <span class="op">=</span> <span class="st">'negative'</span>, </span>
<span>                    precision <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    type <span class="op">=</span> <span class="st">'percent'</span>,</span>
<span>                    create_cm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre>
<p><code>copy_res</code>
“{”rsid”:“igeo1xxpnwcidadobepm”,“id”:“cm300010142_6537f722de0e706af6156fb3”,“name”:“Here
I copy the cm”,“description”:“I want to add a new
description”,“isDeleted”:false,“migratedIds”:[],“internal”:false,“owner”:{“id”:200654087},“hidden”:false,“componentType”:“calculatedMetric”,“polarity”:“negative”,“precision”:2,“type”:“percent”,“definition”:{“formula”:{“func”:“divide”,“col1”:{“func”:“mean”,“description”:“Mean”,“col”:{“func”:“metric”,“name”:“metrics/visits”,“description”:“Visits”},“include-zeros”:false},“col2”:{“func”:“metric”,“name”:“metrics/singlepagevisits”,“description”:“Single
Page
Visits”}},“func”:“calc-metric”,“version”:[1,0,0]},“compatibility”:{“identityMetrics”:[{“identity”:“metrics/visits”},{“identity”:“metrics/singlepagevisits”}],“functions”:[“mean”,“divide”],“validator_version”:“1.0.0”,“supported_products”:[“oberon”],“supported_schema”:[“schema_oberon”,“schema_frag”]},“legacyId”:““,”categories”:[“Calculated
Metrics”],“modified”:“2023-10-24T16:56:02Z”}”</p>
<p><code>cm_val(copy_res)</code> [1] “The calculated metric definition
IS VALID”</p>
</div>
<div class="section level3">
<h3 id="delete-calculated-metrics">Delete calculated metrics<a class="anchor" aria-label="anchor" href="#delete-calculated-metrics"></a>
</h3>
<pre><code><span><span class="op">?</span><span class="va">cm_delete</span></span>
<span></span>
<span><span class="va">deleted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cm_delete.html">cm_delete</a></span><span class="op">(</span></span>
<span>  cm_id <span class="op">=</span> <span class="va">cm_no_seg_filter</span>,</span>
<span>  warn <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  locale <span class="op">=</span> <span class="st">"en_US"</span>,</span>
<span>  debug <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  rsid <span class="op">=</span> <span class="va">rsid</span>,</span>
<span>  company_id <span class="op">=</span> <span class="va">company_id</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>The set of calculated metric functions are setup to enable the end
user to easily incorporate calculated metrics into the analysis and data
science workflows without needing to interact with the UI. At the same
time, the application of integrating the API in workflows enables a
broader set of analytics users to incorporate the results and ongoing
analysis in the powerful and versatile Analysis Workspace. Make sure to
add an issue in Github or add a pull request if you find additional
opportunities of development that would enhance the ability to analyze
and communicate the results using calculated metrics in your
workflows.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="http://github.com/benrwoodard" class="external-link">Ben Woodard</a>, Tim Wilson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
